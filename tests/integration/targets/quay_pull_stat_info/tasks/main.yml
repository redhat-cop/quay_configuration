---
- name: Check whether podman is available
  ansible.builtin.command:
    cmd: podman --version
  failed_when: false
  changed_when: false
  register: podman

# Preparing an image:
# - Pulling a small image from Quay (does not matter what image it is)
# - Tagging it so that it can be pushed to the local Quay Container Registry
# - Pushing the image
# - Deleting the images from the local system
# The tasks do not use the podman collection because it might not be
# available on the testing system.
- name: Ensure the image is prepared with podman
  when: "podman['rc'] == 0"
  block:
    - name: Ensure a small container image is available
      ansible.builtin.command:
        cmd: "podman pull {{ fake_image }}"
      changed_when: true

    - name: Ensure the image has the correct tag
      ansible.builtin.command:
        cmd: "podman tag {{ fake_image }}
              {{ quay_hostname }}/ansibletestorg/ansibletestrepo:latest"
      changed_when: true

    - name: Ensure podman is logged in
      ansible.builtin.command:
        cmd: "podman login --tls-verify=false --username {{ admin_username }}
              --password {{ admin_password }} {{ quay_hostname }}"
      changed_when: true

    - name: Ensure the image is pushed to Quay Container Registry
      ansible.builtin.command:
        cmd: "podman push --tls-verify=false --remove-signatures
              {{ quay_hostname }}/ansibletestorg/ansibletestrepo:latest"
      changed_when: true
      register: result
      retries: 3
      delay: 5
      until: result["rc"] == 0

    - name: Ensure the images are removed
      ansible.builtin.command:
        cmd: "podman rmi {{ fake_image }}
              {{ quay_hostname }}/ansibletestorg/ansibletestrepo:latest"
      changed_when: true

- name: Ensure the image is prepared with docker
  when: "podman['rc'] != 0"
  block:
    - name: Ensure a small container image is available
      ansible.builtin.command:
        cmd: "docker pull {{ fake_image }}"
      changed_when: true

    - name: Ensure the image has the correct tag
      ansible.builtin.command:
        cmd: "docker tag {{ fake_image }}
              {{ quay_hostname }}/ansibletestorg/ansibletestrepo:latest"
      changed_when: true

    - name: Ensure docker is logged in
      ansible.builtin.command:
        cmd: "docker login --username {{ admin_username }}
              --password {{ admin_password }} {{ quay_hostname }}"
      changed_when: true

    - name: Ensure the image is pushed to Quay Container Registry
      ansible.builtin.command:
        cmd: "docker push
              {{ quay_hostname }}/ansibletestorg/ansibletestrepo:latest"
      changed_when: true
      register: result
      retries: 3
      delay: 5
      until: result["rc"] == 0

    - name: Ensure the images are removed
      ansible.builtin.command:
        cmd: "docker rmi {{ fake_image }}
              {{ quay_hostname }}/ansibletestorg/ansibletestrepo:latest"
      changed_when: true

    - name: Ensure docker is logged out
      ansible.builtin.command:
        cmd: "docker logout {{ quay_hostname }}"
      changed_when: true
      failed_when: false

- name: Ensure the tag v1.0.0 is added to the image
  infra.quay_configuration.quay_tag:
    image: ansibletestorg/ansibletestrepo:latest
    tag: v1.0.0
    state: present
    quay_host: "{{ quay_url }}"
    quay_token: "{{ quay_token }}"
    validate_certs: false

- name: Getting the stats for the ansibletestorg/ansibletestrepo:latest image
  infra.quay_configuration.quay_pull_stat_info:
    repository: ansibletestorg/ansibletestrepo
    quay_host: "{{ quay_url }}"
    quay_token: "{{ quay_token }}"
    validate_certs: false
  register: t

- name: Ensure that the task did not change anything
  ansible.builtin.assert:
    that: not t['changed']
    fail_msg: The preceding task should not have changed anything

- name: Display result 1
  ansible.builtin.debug:
    var: t

- name: Getting the stats for the ansibletestorg/ansibletestrepo:v1.0.0 image
  infra.quay_configuration.quay_pull_stat_info:
    repository: ansibletestorg/ansibletestrepo
    tag: v1.0.0
    quay_host: "{{ quay_url }}"
    quay_token: "{{ quay_token }}"
    validate_certs: false
  register: t

- name: Ensure that the task did not change anything
  ansible.builtin.assert:
    that: not t['changed']
    fail_msg: The preceding task should not have changed anything

- name: Display result 2
  ansible.builtin.debug:
    var: t

- name: Getting the stats for a nonexisting repository
  infra.quay_configuration.quay_pull_stat_info:
    repository: nosuchrepository
    digest:
      sha256:a8f231c07da40107543d74ed1e9a1938a004b498377dbefcf29082c7a9e55ea7
    quay_host: "{{ quay_url }}"
    quay_token: "{{ quay_token }}"
    validate_certs: false
  register: t

- name: Ensure that the task did not change anything
  ansible.builtin.assert:
    that: not t['changed']
    fail_msg: The preceding task should not have changed anything

- name: Display result 3
  ansible.builtin.debug:
    var: t

- name: Getting the stats for a nonexisting digest
  infra.quay_configuration.quay_pull_stat_info:
    repository: ansibletestorg/ansibletestrepo
    digest:
      sha256:a8f231c07da40107543d74ed1e9a1938a004b498377dbefcf29082c7a9e55ea7
    quay_host: "{{ quay_url }}"
    quay_token: "{{ quay_token }}"
    validate_certs: false
  register: t

- name: Ensure that the task did not change anything
  ansible.builtin.assert:
    that: not t['changed']
    fail_msg: The preceding task should not have changed anything

- name: Display result 4
  ansible.builtin.debug:
    var: t

- name: Ensure the repository is removed
  infra.quay_configuration.quay_repository:
    name: ansibletestorg/ansibletestrepo
    state: absent
    quay_host: "{{ quay_url }}"
    quay_token: "{{ quay_token }}"
    validate_certs: false
...
